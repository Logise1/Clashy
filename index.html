<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clashy Royale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Titan+One&display=swap" rel="stylesheet">
    
    <style>
        :root { --font-toon: 'Titan One', cursive; }
        * { -webkit-tap-highlight-color: transparent; user-select: none; }
        input { user-select: text !important; -webkit-user-select: text !important; }
        
        body {
            font-family: var(--font-toon);
            background-color: #121212;
            overflow: hidden; touch-action: none;
            height: 100dvh; width: 100vw;
            display: flex; flex-direction: column;
        }

        #app-loader {
            position: fixed; inset: 0; z-index: 9999;
            background: #222; color: white;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column; transition: opacity 0.5s;
            pointer-events: auto;
        }

        /* --- FONDO DIN√ÅMICO & PART√çCULAS --- */
        .toon-bg {
            position: absolute; inset: 0; z-index: -3;
            background: #5dbb63; /* Color base din√°mico */
            transition: background 1s ease;
        }
        
        /* Part√≠culas de Tierra/Polvo */
        .particles {
            position: absolute; inset: 0; pointer-events: none; z-index: -2;
            background-image: 
                radial-gradient(rgba(101, 67, 33, 0.6) 3px, transparent 3px),
                radial-gradient(rgba(139, 69, 19, 0.5) 2px, transparent 2px);
            background-size: 80px 80px;
            background-position: 0 0, 40px 40px;
            animation: particleMove 20s linear infinite;
            opacity: 0.8;
        }
        @keyframes particleMove { 
            from { background-position: 0 0, 40px 40px; } 
            to { background-position: 0 -800px, 40px -760px; } /* Flotan hacia arriba */
        }

        .river {
            position: absolute; top: 45%; left: -10%; width: 120%; height: 8vh;
            background: #4fc3f7; border-top: 0.5vh solid #000; border-bottom: 0.5vh solid #000;
            transform: rotate(-2deg); z-index: -1; pointer-events: none;
        }

        /* --- UI ESTILO ROYALE MEJORADA --- */
        .arena-scroll-container {
            flex: 1; overflow-y: auto; overflow-x: hidden;
            display: flex; flex-direction: column-reverse; /* Empezamos abajo */
            align-items: center; padding-top: 100px; padding-bottom: 120px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .arena-card {
            width: 85%; max-width: 350px; margin: 15px 0;
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
            border: 4px solid #333; border-radius: 20px;
            padding: 20px; text-align: center; position: relative;
            transform: scale(0.95); opacity: 0.9; transition: all 0.3s;
            box-shadow: 0 8px 0 rgba(0,0,0,0.3);
        }
        .arena-card.active {
            transform: scale(1.05); opacity: 1; border-color: #ffd700;
            background: linear-gradient(135deg, #fffbe6 0%, #fff 100%);
            box-shadow: 0 0 0 4px rgba(255, 215, 0, 0.5), 0 12px 0 rgba(0,0,0,0.4); 
            z-index: 10;
        }
        .arena-card.locked { 
            filter: grayscale(1); background: #ccc; border-color: #666; opacity: 0.7;
        }
        
        .arena-icon { font-size: 70px; margin-bottom: 5px; display: block; filter: drop-shadow(0 4px 0 rgba(0,0,0,0.2)); }
        
        /* FOOTER DE COMBATE */
        .battle-footer {
            position: absolute; bottom: 0; left: 0; right: 0;
            height: 100px; background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center; gap: 15px;
            border-top: 4px solid #000; z-index: 50; padding-bottom: max(10px, env(safe-area-inset-bottom));
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }

        /* HEADER */
        .top-bar {
            position: absolute; top: 0; left: 0; right: 0;
            height: 70px; background: rgba(20, 20, 20, 0.9); backdrop-filter: blur(5px);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; z-index: 50; border-bottom: 4px solid #000;
            padding-top: max(10px, env(safe-area-inset-top));
        }

        /* Inputs & Btns */
        .toon-panel { background: white; border: 4px solid black; border-radius: 20px; padding: 20px; box-shadow: 8px 8px 0 rgba(0,0,0,0.3); }
        .toon-input { width: 100%; padding: 10px; margin-bottom: 10px; border: 2px solid #333; border-radius: 10px; background: #eee; font-weight: bold; pointer-events: auto; }
        .toon-btn { border: 3px solid #000; border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.1s; }
        .toon-btn:active { transform: translateY(4px); box-shadow: none !important; }
        
        .btn-red { background: #ff4757; box-shadow: 0 6px 0 #c0392b; color: white; }
        .btn-blue { background: #2ed573; box-shadow: 0 6px 0 #27ae60; color: white; }
        .btn-gold { background: #f1c40f; box-shadow: 0 6px 0 #d4ac0d; color: #333; }
        .btn-purple { background: #5352ed; box-shadow: 0 6px 0 #3742fa; color: white; }

        /* --- GAME ELEMENTS --- */
        .hp-bar-container { height: 24px; background: #333; border: 3px solid #000; border-radius: 12px; overflow: hidden; position: relative; }
        .hp-fill { height: 100%; transition: width 0.2s; border-right: 2px solid rgba(0,0,0,0.3); }
        .dot { width: 20px; height: 20px; border-radius: 50%; background: #444; border: 2px solid #000; transition: all 0.2s; }
        .dot.filled { transform: scale(1.2); box-shadow: 0 0 0 2px #fff; border-color: #000; }
        
        .toon-char { font-size: 100px; filter: drop-shadow(4px 4px 0 #000); transition: transform 0.1s; z-index: 5; }
        
        /* Animaciones */
        .zoom-in { animation: zoomIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .zoom-out { animation: zoomOut 0.4s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards; }
        @keyframes zoomIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes zoomOut { from { transform: scale(1); opacity: 1; } to { transform: scale(0.5); opacity: 0; } }
        
        .hit-squash { animation: squash 0.3s; filter: brightness(2) hue-rotate(90deg) !important; }
        .stunned { filter: grayscale(1) blur(2px); animation: shake 0.5s infinite; }
        @keyframes squash { 0% { transform: scale(1, 1); } 30% { transform: scale(1.4, 0.6); } 100% { transform: scale(1, 1); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        
        .dmg-pop { position: absolute; font-size: 40px; color: #fff; -webkit-text-stroke: 2px black; text-shadow: 3px 3px 0 #000; animation: popUp 0.8s forwards; pointer-events: none; z-index: 50; }
        @keyframes popUp { 0% { transform: scale(0); } 50% { transform: scale(1.5) translateY(-40px); } 100% { transform: scale(1) translateY(-80px); opacity: 0; } }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="app-loader">
        <h1 class="text-4xl animate-bounce mb-4 text-[#ff4757] -webkit-text-stroke-2 stroke-black">CLASHY</h1>
        <div id="loader-txt" class="text-sm font-sans font-bold text-gray-400">Conectando...</div>
    </div>

    <!-- FONDO DIN√ÅMICO + PARTICULAS -->
    <div id="dynamic-bg" class="toon-bg"></div>
    <div class="particles"></div>
    <div class="river"></div>

    <!-- PANTALLA LOGIN -->
    <div id="screen-login" class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="toon-panel w-full max-w-sm text-center transform rotate-1 zoom-in relative">
            <button onclick="app.closeLogin()" class="hidden absolute -top-3 -right-3 w-10 h-10 bg-red-500 rounded-full border-2 border-black text-white font-bold" id="btn-close-login">X</button>
            <h1 class="text-5xl text-[#ff4757] -webkit-text-stroke-2 stroke-black drop-shadow-md mb-4">CUENTA</h1>
            <div class="flex mb-4 gap-2">
                <button onclick="app.setTab('login')" id="tab-login" class="flex-1 py-2 font-bold border-b-4 border-blue-500 text-blue-500">ENTRAR</button>
                <button onclick="app.setTab('register')" id="tab-register" class="flex-1 py-2 font-bold border-b-4 border-transparent text-gray-400">CREAR</button>
            </div>
            <div id="form-container">
                <input type="text" id="inp-user" placeholder="Nombre" class="toon-input">
                <input type="password" id="inp-pass" placeholder="Clave" class="toon-input">
                <button onclick="app.submitAuth()" class="toon-btn btn-blue w-full h-14 text-xl font-black uppercase mb-2">INICIAR</button>
                <div id="login-msg" class="text-red-500 font-sans text-sm font-bold min-h-[20px]"></div>
            </div>
            <button id="btn-guest" onclick="app.playAsGuest()" class="mt-4 text-gray-500 font-bold underline text-sm cursor-pointer">Jugar como Invitado</button>
        </div>
    </div>

    <!-- PANTALLA MENU (ESTILO ROYALE) -->
    <div id="screen-menu" class="absolute inset-0 z-40 flex flex-col">
        
        <!-- TOP BAR -->
        <div class="top-bar">
            <div class="flex items-center gap-2" onclick="app.goToLoginScreen(true)">
                <div id="menu-avatar-display" class="w-10 h-10 rounded-full bg-blue-100 border-2 border-black flex items-center justify-center text-2xl cursor-pointer">ü§†</div>
                <div class="flex flex-col items-start leading-none">
                    <span id="menu-user" class="font-bold text-sm text-white drop-shadow-md">Invitado</span>
                    <div class="bg-yellow-400 px-2 rounded-full border border-black text-[10px] font-black text-black">NVL 1</div>
                </div>
            </div>
            <div class="flex items-center gap-2 bg-black/40 px-3 py-1 rounded-full border border-white/20">
                <i class="fas fa-trophy text-yellow-400"></i>
                <span id="menu-trophies" class="text-xl font-black text-white">0</span>
            </div>
        </div>

        <!-- ARENA SCROLLER (VERTICAL) -->
        <div id="arena-scroller" class="arena-scroll-container">
            <!-- Arenas generadas por JS -->
        </div>

        <!-- FOOTER -->
        <div class="battle-footer">
            <button onclick="app.toggleSkins()" class="toon-btn btn-purple h-16 w-16 text-2xl shadow-lg">
                <i class="fas fa-mask"></i>
            </button>
            
            <button onclick="game.startLocal()" class="toon-btn btn-gold h-20 w-40 text-2xl font-black uppercase shadow-xl -mt-8 animate-bounce">
                LUCHAR
            </button>
            
            <button onclick="app.showLobby()" class="toon-btn btn-blue h-16 w-16 text-xl shadow-lg">
                <i class="fas fa-user-friends"></i>
            </button>
        </div>
    </div>

    <!-- LOBBY ONLINE -->
    <div id="screen-lobby" class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center p-4 bg-black/80">
        <div class="toon-panel w-full max-w-sm text-center zoom-in relative">
            <button onclick="document.getElementById('screen-lobby').classList.add('hidden')" class="absolute -top-3 -right-3 w-10 h-10 bg-red-500 rounded-full border-2 border-black text-white font-bold">X</button>
            <h2 class="text-3xl text-[#2ed573] font-black mb-4 stroke-black">VS AMIGO</h2>
            <div class="mb-6">
                <p class="text-sm font-bold text-gray-600 mb-2">CREAR SALA</p>
                <div class="flex gap-2">
                    <input type="text" id="create-room-code" readonly class="toon-input text-center text-xl tracking-widest bg-yellow-100 border-yellow-500" value="...">
                    <button onclick="multiplayer.createRoom()" class="toon-btn btn-gold w-24 font-bold">CREAR</button>
                </div>
                <div id="host-msg" class="text-xs font-bold text-blue-500 h-4"></div>
            </div>
            <div class="border-t-2 border-gray-200 pt-4">
                <p class="text-sm font-bold text-gray-600 mb-2">UNIRSE A SALA</p>
                <div class="flex gap-2">
                    <input type="text" id="join-room-code" placeholder="C√ìDIGO" class="toon-input text-center text-xl tracking-widest uppercase">
                    <button onclick="multiplayer.joinRoom()" class="toon-btn btn-blue w-24 font-bold">ENTRAR</button>
                </div>
                <div id="join-msg" class="text-xs font-bold text-red-500 h-4"></div>
            </div>
        </div>
    </div>

    <!-- SKINS -->
    <div id="modal-skins" class="hidden absolute inset-0 z-50 flex items-center justify-center bg-black/80 p-4">
        <div class="toon-panel w-full max-w-sm text-center zoom-in relative">
            <button onclick="app.toggleSkins()" class="absolute -top-3 -right-3 w-10 h-10 bg-red-500 rounded-full border-2 border-black text-white font-bold">X</button>
            <h2 class="text-3xl text-[#5352ed] font-black mb-4 -webkit-text-stroke-1 stroke-black text-white">COLECCI√ìN</h2>
            <div id="skins-container" class="skin-grid" style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px;"></div>
            <button onclick="app.saveSkin()" class="toon-btn btn-blue w-full h-12 text-xl font-black uppercase mt-4">EQUIPAR</button>
        </div>
    </div>

    <!-- GAME -->
    <div id="screen-game" class="hidden absolute inset-0 z-10 flex flex-col h-full w-full">
        <div id="game-container" class="w-full h-full flex flex-col">
            <!-- RIVAL -->
            <div class="h-[40%] flex flex-col items-center justify-center relative">
                <div class="w-[80%] max-w-md absolute top-4 z-20">
                    <div class="flex justify-between text-white font-black text-[2vh] mb-1 drop-shadow-md px-1">
                        <span class="text-red-500 stroke-black" style="-webkit-text-stroke: 1px black;">RIVAL</span>
                        <span id="e-hp-txt">300</span>
                    </div>
                    <div class="hp-bar-container"><div id="e-hp-bar" class="hp-fill bg-[#ff4757]"></div></div>
                    <div class="flex justify-center gap-2 mt-1">
                        <div id="e-dot-1" class="dot bg-red-600"></div><div id="e-dot-2" class="dot bg-red-600"></div><div id="e-dot-3" class="dot bg-red-600"></div>
                    </div>
                </div>
                <div class="relative mt-8">
                    <div id="e-sprite" class="toon-char scale-x-[-1]">üëπ</div>
                    <div id="e-emote" class="absolute -top-[5vh] -right-[5vh] bg-white border-4 border-black p-2 rounded-full hidden animate-bounce z-30 text-[4vh]">üõ°Ô∏è</div>
                    <div id="e-shield" class="absolute -inset-[2vh] border-[1vh] border-blue-400 rounded-full opacity-0 scale-75 transition-all"></div>
                </div>
            </div>

            <!-- PLAYER -->
            <div class="h-[60%] flex flex-col items-center justify-end pb-[safe-area-inset-bottom] relative">
                <div id="status-msg" class="absolute top-10 text-white font-black text-[3vh] drop-shadow-md opacity-0 bg-black/50 px-4 rounded-full pointer-events-none z-50"></div>
                
                <div class="relative mb-2">
                    <div id="p-sprite" class="toon-char">ü§†</div>
                    <div id="p-shield" class="absolute -inset-[2vh] border-[1vh] border-blue-400 rounded-full opacity-0 scale-75 transition-all"></div>
                </div>

                <div class="w-[80%] max-w-md mb-4">
                    <div class="flex justify-between text-white font-black text-[2vh] mb-1 drop-shadow-md px-1">
                        <span class="text-blue-400 stroke-black" style="-webkit-text-stroke: 1px black;">T√ö</span>
                        <span id="p-hp-txt">300</span>
                    </div>
                    <div class="hp-bar-container"><div id="p-hp-bar" class="hp-fill bg-[#2ed573]"></div></div>
                    <div class="flex justify-center gap-2 mt-1">
                        <div id="p-dot-1" class="dot bg-[#2ed573]"></div><div id="p-dot-2" class="dot bg-[#2ed573]"></div><div id="p-dot-3" class="dot bg-[#2ed573]"></div>
                    </div>
                </div>

                <div class="w-full px-4 pb-6 grid grid-cols-3 gap-3 h-[18vh] max-h-[160px] max-w-lg relative">
                    <button id="btn-reload" onclick="game.action('reload')" class="toon-btn btn-blue group">
                        <i class="fas fa-bolt group-active:scale-90 transition-transform text-[4vh]"></i>
                        <span class="font-black uppercase text-[1.5vh]">Cargar</span>
                    </button>
                    <button id="btn-defend" onclick="game.action('defend')" class="toon-btn btn-purple group">
                        <i class="fas fa-shield-alt group-active:scale-90 transition-transform text-[4vh]"></i>
                        <span class="font-black uppercase text-[1.5vh] text-xs">Escudo(1)</span>
                    </button>
                    <button id="btn-attack" onclick="game.action('attack')" class="toon-btn btn-red group z-20 transform -translate-y-[1vh]">
                        <i class="fas fa-bomb text-[5vh] group-active:scale-90 transition-transform"></i>
                        <span class="text-[2vh] font-black mt-1 uppercase">¬°FUEGO!</span>
                    </button>
                </div>
            </div>
            <div id="fx-layer" class="absolute inset-0 pointer-events-none overflow-hidden"></div>
        </div>
    </div>

    <!-- MODAL FINAL -->
    <div id="modal-end" class="hidden absolute inset-0 z-50 flex items-center justify-center bg-black/80 p-4">
        <div class="toon-panel w-full max-w-sm text-center transform rotate-1 zoom-in">
            <h2 id="modal-title" class="text-5xl font-black mb-4 -webkit-text-stroke-2 stroke-black text-[#f1c40f]">¬°VICTORIA!</h2>
            <div class="flex justify-center items-center gap-4 mb-8">
                <span class="text-6xl">üèÜ</span>
                <span id="trophy-change" class="text-5xl font-black text-[#333]">+20</span>
            </div>
            <button onclick="game.toMenu()" class="toon-btn btn-blue w-full h-16 text-2xl font-black uppercase">CONTINUAR</button>
        </div>
    </div>

    <!-- POPUP LOGIN -->
    <div id="modal-popup-login" class="hidden absolute inset-0 z-60 flex items-center justify-center bg-black/90 p-4">
        <div class="toon-panel w-full max-w-sm text-center zoom-in relative">
            <button onclick="app.skipPopup()" class="absolute top-2 right-4 text-gray-400 font-bold text-2xl">√ó</button>
            <h2 class="text-3xl text-[#5352ed] font-black mb-2 stroke-black">¬°GUARDA COPAS!</h2>
            <p class="text-sm text-gray-600 mb-6 font-bold">Llevas 3 partidas. Crea una cuenta para no perder tu progreso.</p>
            <button onclick="app.goToLoginScreen(true)" class="toon-btn btn-gold w-full h-14 text-xl font-black uppercase mb-2">CREAR CUENTA</button>
            <button onclick="app.skipPopup()" class="text-xs text-gray-400 font-bold underline mt-2">Seguir como invitado</button>
        </div>
    </div>

    <!-- RANKING -->
    <div id="screen-ranking" class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center p-4 bg-black/80">
        <div class="toon-panel w-full max-w-sm text-center relative zoom-in">
            <button onclick="document.getElementById('screen-ranking').classList.add('hidden')" class="absolute -top-4 -right-4 bg-red-500 text-white w-10 h-10 rounded-full border-2 border-black font-bold">X</button>
            <h2 class="text-3xl text-[#f1c40f] -webkit-text-stroke-1 stroke-black mb-4 drop-shadow-md font-black">TOP MUNDIAL</h2>
            <div id="ranking-list" class="bg-gray-100 rounded-xl h-64 overflow-y-auto text-left font-sans text-sm border-2 border-gray-300 p-2">
                <div class="text-center text-gray-400 mt-10">Cargando...</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, limit, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // CONFIG FORCE
        const firebaseConfig = { apiKey: "AIzaSyBi5fQUumRe3zDb82mOcbl_m3JxP_9vVO4", authDomain: "toon-acb19.firebaseapp.com", projectId: "toon-acb19", storageBucket: "toon-acb19.firebasestorage.app", messagingSenderId: "627627273918", appId: "1:627627273918:web:558d7b607d2b780c6e38ef", measurementId: "G-JG4FRWR4DZ" };
        const appId = 'clashy-ultimate';

        let fApp, auth, db;
        try { fApp = initializeApp(firebaseConfig); auth = getAuth(fApp); db = getFirestore(fApp); } catch (e) { console.error(e); }

        const SKINS = [
            {icon:'ü§†', cost:0}, {icon:'üëΩ', cost:0}, {icon:'ü§ñ', cost:50}, 
            {icon:'ü¶Ñ', cost:100}, {icon:'üíÄ', cost:200}, {icon:'üéÉ', cost:300}, 
            {icon:'ü§°', cost:400}, {icon:'üê±', cost:500}, {icon:'üê∂', cost:600}, 
            {icon:'üê∏', cost:700}, {icon:'üëª', cost:800}, {icon:'üí©', cost:1000},
            {icon:'ü¶Å', cost:1200}, {icon:'üê≤', cost:1500}, {icon:'üëë', cost:2000},
            {icon:'üëæ', cost:2500}, {icon:'üëπ', cost:3000}, {icon:'üòà', cost:3500},
            {icon:'ü•∂', cost:4000}, {icon:'ü•µ', cost:5000}
        ];

        // --- ARENAS SYSTEM ---
        const ARENAS = [
            {min: 0, name: "ENTRENAMIENTO", bg: "#5dbb63", icon: "üå≤"},
            {min: 100, name: "DESIERTO SECO", bg: "#e67e22", icon: "üåµ"},
            {min: 300, name: "VALLE EL√âCTRICO", bg: "#8e44ad", icon: "‚ö°"},
            {min: 600, name: "PICO HELADO", bg: "#3498db", icon: "‚ùÑÔ∏è"},
            {min: 1000, name: "ARENA LEGENDARIA", bg: "#f1c40f", icon: "üèÜ"}
        ];

        // --- AUDIO MEJORADO (No 8-bit) ---
        const AudioSys = {
            ctx: null,
            init() { if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); },
            play(type) {
                if(!this.ctx) return;
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain); gain.connect(this.ctx.destination);

                if(type === 'hit') {
                    // Sawtooth impact, lower frequency
                    osc.type = 'sawtooth'; 
                    osc.frequency.setValueAtTime(100, t); 
                    osc.frequency.exponentialRampToValueAtTime(0.01, t + 0.1);
                    gain.gain.setValueAtTime(0.5, t); 
                    gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
                    osc.start(t); osc.stop(t + 0.1);
                } else if(type === 'shoot') {
                    // Soft laser "Pew"
                    osc.type = 'triangle'; 
                    osc.frequency.setValueAtTime(600, t); 
                    osc.frequency.exponentialRampToValueAtTime(100, t + 0.15); 
                    gain.gain.setValueAtTime(0.3, t); 
                    gain.gain.exponentialRampToValueAtTime(0.01, t + 0.15); 
                    osc.start(t); osc.stop(t + 0.15);
                } else if(type === 'shield') {
                    // Forcefield "Womp"
                    osc.type = 'sine'; 
                    osc.frequency.setValueAtTime(100, t); 
                    osc.frequency.linearRampToValueAtTime(250, t + 0.1);
                    osc.frequency.linearRampToValueAtTime(100, t + 0.3);
                    gain.gain.setValueAtTime(0.4, t); 
                    gain.gain.exponentialRampToValueAtTime(0.01, t + 0.3);
                    osc.start(t); osc.stop(t + 0.3);
                } else if(type === 'reload') {
                    // Power up "Ching"
                    osc.type = 'sine'; 
                    osc.frequency.setValueAtTime(300, t); 
                    osc.frequency.exponentialRampToValueAtTime(600, t + 0.15); 
                    gain.gain.setValueAtTime(0.1, t); 
                    gain.gain.exponentialRampToValueAtTime(0.01, t + 0.15); 
                    osc.start(t); osc.stop(t + 0.15);
                } else if(type === 'click') {
                    osc.type = 'triangle'; osc.frequency.setValueAtTime(800, t); gain.gain.setValueAtTime(0.05, t); gain.gain.exponentialRampToValueAtTime(0.01, t+0.05); osc.start(t); osc.stop(t+0.05);
                }
            },
            playMusic(type) {
                if(!this.ctx) return;
                if(type === 'win') {
                    [523, 659, 784, 1046].forEach((f, i) => {
                        const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
                        o.connect(g); g.connect(this.ctx.destination);
                        o.type = 'triangle'; o.frequency.value = f;
                        g.gain.setValueAtTime(0.3, this.ctx.currentTime + i*0.1);
                        g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + i*0.1 + 0.3);
                        o.start(this.ctx.currentTime + i*0.1); o.stop(this.ctx.currentTime + i*0.1 + 0.3);
                    });
                } else if(type === 'bgm') {
                    const now = this.ctx.currentTime;
                    const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
                    o.connect(g); g.connect(this.ctx.destination);
                    o.type = 'triangle';
                    o.frequency.setValueAtTime(220, now);
                    o.frequency.exponentialRampToValueAtTime(440, now+0.1);
                    g.gain.setValueAtTime(0.05, now);
                    g.gain.linearRampToValueAtTime(0, now+0.2);
                    o.start(now); o.stop(now+0.2);
                }
            }
        };

        window.app = {
            user: null, realUser: null, trophies: parseInt(localStorage.getItem('clashy_trophies')||0),
            matchesPlayed: parseInt(localStorage.getItem('clashy_matches')||0), currentSkin: localStorage.getItem('clashy_skin')||SKINS[0].icon,
            authMode: 'login',

            getArena() { return ARENAS.slice().reverse().find(a => this.trophies >= a.min) || ARENAS[0]; },

            setTab(m) {
                this.authMode=m;
                document.getElementById('tab-login').className = m==='login' ? "flex-1 py-2 font-bold border-b-4 border-blue-500 text-blue-500" : "flex-1 py-2 font-bold border-b-4 border-transparent text-gray-400";
                document.getElementById('tab-register').className = m==='register' ? "flex-1 py-2 font-bold border-b-4 border-purple-500 text-purple-500" : "flex-1 py-2 font-bold border-b-4 border-transparent text-gray-400";
            },

            renderArenas() {
                const c = document.getElementById('arena-scroller');
                c.innerHTML = '';
                const currentArena = this.getArena();
                ARENAS.forEach((a, idx) => {
                    const el = document.createElement('div');
                    const isUnlocked = this.trophies >= a.min;
                    const isCurrent = currentArena.min === a.min;
                    el.className = `arena-card ${isUnlocked ? (isCurrent ? 'active' : '') : 'locked'}`;
                    el.innerHTML = `<div class="text-xs font-black uppercase text-gray-400 mb-1">Arena ${idx+1}</div><div class="arena-icon">${a.icon}</div><div class="text-2xl font-black uppercase mb-1">${a.name}</div><div class="text-sm font-bold text-gray-500">${a.min}+ Copas</div>`;
                    if(isCurrent) { el.innerHTML += `<div class="mt-2 bg-yellow-400 text-black text-xs font-bold px-2 py-1 rounded-full inline-block">EST√ÅS AQU√ç</div>`; this.currentArenaEl = el; }
                    c.appendChild(el);
                });
                c.appendChild(document.createElement('div')).style.height = "20px";
            },

            getUserDoc: (u) => doc(db, 'artifacts', appId, 'public', 'data', 'users', u),
            
            submitAuth: async () => {
                const u = document.getElementById('inp-user').value.trim();
                const p = document.getElementById('inp-pass').value.trim();
                const m = document.getElementById('login-msg');
                if(!u||!p) { m.innerText="Faltan datos"; return; }
                m.innerText="...";
                try {
                    const ref = window.app.getUserDoc(u);
                    const snap = await getDoc(ref);
                    if(window.app.authMode==='login') {
                        if(snap.exists()&&snap.data().pass===p) {
                            window.app.realUser = snap.data();
                            window.app.trophies = snap.data().trophies;
                            if(snap.data().skin) window.app.currentSkin = snap.data().skin;
                            window.app.saveLocal(); window.app.closeLogin(); window.game.updateMenuUI();
                        } else m.innerText="Error login";
                    } else {
                        if(snap.exists()) m.innerText="Ya existe";
                        else {
                            const prof = {username:u,pass:p,trophies:window.app.trophies,skin:window.app.currentSkin};
                            await setDoc(ref,prof); window.app.realUser=prof; window.app.saveLocal(); window.app.closeLogin(); window.game.updateMenuUI();
                        }
                    }
                } catch(e){ console.log(e); m.innerText="Error red"; }
            },

            logout: () => { window.app.realUser=null; localStorage.removeItem('clashy_user_session'); window.location.reload(); },
            playAsGuest: () => { window.app.closeLogin(); game.init(); },
            goToLoginScreen: (fm) => {
                document.getElementById('modal-popup-login').classList.add('hidden');
                document.getElementById('screen-login').classList.remove('hidden');
                document.getElementById('btn-close-login').classList.toggle('hidden',!fm);
                document.getElementById('btn-guest').classList.toggle('hidden',fm);
            },
            closeLogin: () => { document.getElementById('screen-login').classList.add('hidden'); },
            skipPopup: () => { document.getElementById('modal-popup-login').classList.add('hidden'); game.toMenuActual(); },
            
            saveLocal: () => {
                localStorage.setItem('clashy_trophies', window.app.trophies);
                localStorage.setItem('clashy_matches', window.app.matchesPlayed);
                localStorage.setItem('clashy_skin', window.app.currentSkin);
                if(window.app.realUser) {
                    localStorage.setItem('clashy_user_session', window.app.realUser.username);
                    setDoc(window.app.getUserDoc(window.app.realUser.username), { trophies:window.app.trophies, skin:window.app.currentSkin }, {merge:true});
                }
            },

            toggleSkins: () => {
                const m = document.getElementById('modal-skins');
                if(m.classList.contains('hidden')) {
                    const c = document.getElementById('skins-container'); c.innerHTML='';
                    SKINS.forEach(s => {
                        const l = window.app.trophies < s.cost;
                        const d = document.createElement('div');
                        d.className=`skin-item ${s.icon===window.app.currentSkin?'selected':''} ${l?'locked':''}`;
                        d.innerHTML = l ? `${s.icon}<div class="lock-overlay">üîí${s.cost}</div>` : s.icon;
                        if(!l) d.onclick=()=>{window.app.currentSkin=s.icon; app.toggleSkins(); app.toggleSkins(); app.saveLocal();};
                        c.appendChild(d);
                    });
                    m.classList.remove('hidden');
                } else m.classList.add('hidden');
            },
            saveSkin: () => { app.saveLocal(); document.getElementById('modal-skins').classList.add('hidden'); document.getElementById('menu-avatar-display').innerText=window.app.currentSkin; },
            
            showLobby: () => { document.getElementById('screen-lobby').classList.remove('hidden'); document.getElementById('create-room-code').value=Math.random().toString(36).substring(7).toUpperCase(); }
        };

        window.multiplayer = {
            roomId: null, role: null, unsubscribe: null,
            getMatchRef: (id) => doc(db, 'artifacts', appId, 'public', 'data', 'matches', id),
            createRoom: async () => {
                const code = document.getElementById('create-room-code').value;
                document.getElementById('host-msg').innerText = "Esperando...";
                const ref = multiplayer.getMatchRef(code);
                await setDoc(ref, { host:window.app.currentSkin, guest:null, p1:{hp:300,ammo:0,shield:false}, p2:{hp:300,ammo:0,shield:false}, status:'waiting', lastAction:Date.now() });
                multiplayer.roomId=code; multiplayer.role='host'; multiplayer.listen(ref);
            },
            joinRoom: async () => {
                const code = document.getElementById('join-room-code').value;
                const ref = multiplayer.getMatchRef(code);
                const s = await getDoc(ref);
                if(s.exists() && s.data().status==='waiting') {
                    await setDoc(ref, { guest:window.app.currentSkin, status:'playing' }, {merge:true});
                    multiplayer.roomId=code; multiplayer.role='guest'; multiplayer.listen(ref);
                } else document.getElementById('join-msg').innerText = "Error sala";
            },
            listen: (ref) => {
                multiplayer.unsubscribe = onSnapshot(ref, (d) => {
                    const dat = d.data(); if(!dat) return;
                    if(dat.status==='playing') {
                        document.getElementById('screen-lobby').classList.add('hidden');
                        if(!game.state) game.startOnline(dat);
                        else {
                            const key = multiplayer.role==='host'?'p2':'p1';
                            const opp = dat[key];
                            if(opp.hp < game.state.e.hp) game.hit(false, game.state.e);
                        }
                    }
                });
            },
            sendState: async (type) => {
                if(!multiplayer.roomId) return;
                const key = multiplayer.role === 'host' ? 'p1' : 'p2';
                const ref = multiplayer.getMatchRef(multiplayer.roomId);
                const up = {}; up[key] = { hp: game.state.p.hp, ammo: game.state.p.ammo, shield: game.state.p.shield };
                await setDoc(ref, up, { merge: true });
            }
        };

        window.game = {
            dom: null, state: null, mode: 'local',
            
            init() {
                this.dom = {
                    menu: document.getElementById('screen-menu'),
                    menuCont: document.getElementById('menu-container'),
                    game: document.getElementById('screen-game'),
                    gameCont: document.getElementById('game-container'),
                    modalEnd: document.getElementById('modal-end'),
                    p: { hp: document.getElementById('p-hp-bar'), txt: document.getElementById('p-hp-txt'), sprite: document.getElementById('p-sprite'), dots: [1,2,3].map(i=>document.getElementById(`p-dot-${i}`)), shield: document.getElementById('p-shield') },
                    e: { hp: document.getElementById('e-hp-bar'), txt: document.getElementById('e-hp-txt'), sprite: document.getElementById('e-sprite'), dots: [1,2,3].map(i=>document.getElementById(`e-dot-${i}`)), shield: document.getElementById('e-shield'), emote: document.getElementById('e-emote') },
                    btns: { atk: document.getElementById('btn-attack'), def: document.getElementById('btn-defend'), rel: document.getElementById('btn-reload') }
                };
                this.updateMenuUI();
                const l = document.getElementById('app-loader'); l.style.opacity='0'; setTimeout(()=>l.style.display='none',500);
            },

            updateMenuUI() {
                document.getElementById('menu-trophies').innerText = window.app.trophies;
                document.getElementById('menu-avatar-display').innerText = window.app.currentSkin;
                const uLabel = document.getElementById('menu-user');
                if(window.app.realUser) uLabel.innerText = window.app.realUser.username;
                else uLabel.innerText = "Invitado";
                
                const arena = window.app.getArena();
                document.querySelector('.toon-bg').style.background = arena.bg;
                window.app.renderArenas();
                
                if(window.app.currentArenaEl) window.app.currentArenaEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            },

            startLocal() { this.mode='local'; this.start(); },
            startOnline(d) { this.mode='online'; this.start(d); },

            start(od=null) {
                document.getElementById('screen-menu').style.display = 'none';
                this.dom.game.classList.remove('hidden');

                this.dom.p.sprite.innerText = window.app.currentSkin;
                if(od) {
                    this.dom.e.sprite.innerText = (window.multiplayer.role === 'host') ? od.guest : od.host;
                } else {
                    let rand = SKINS[Math.floor(Math.random()*SKINS.length)].icon;
                    while(rand === window.app.currentSkin) rand = SKINS[Math.floor(Math.random()*SKINS.length)].icon;
                    this.dom.e.sprite.innerText = rand;
                }

                this.state = {
                    active: true,
                    p: { hp: 300, max: 300, ammo: 0, shield: false, cd: 0, dmg: 20 },
                    e: { hp: 300, max: 300, ammo: 0, shield: false, cd: 0, dmg: 20 }
                };

                this.updateUI();
                this.loops = setInterval(() => this.loop(), 50);
                if(this.mode === 'local') {
                    let speed = 2000;
                    if(window.app.trophies > 50) speed = 1000;
                    if(window.app.trophies > 200) speed = 600;
                    this.aiInt = setInterval(() => this.ai(), speed);
                }
            },

            loop() {
                if(this.state.p.cd > 0) this.state.p.cd -= 50;
                if(this.state.e.cd > 0) this.state.e.cd -= 50;
                this.updateBtns();
            },

            ai() {
                if(!this.state.active || this.state.e.cd > 0) return;
                const p = this.state.p; const e = this.state.e;
                let act = 'reload';
                if (e.ammo === 0) act = 'reload';
                else {
                    if (p.ammo === 0 && e.ammo > 0) act = 'attack';
                    else if (p.ammo > 0 && Math.random() < 0.4) { act = 'defend'; this.emote('üõ°Ô∏è'); }
                    else act = e.ammo < 3 ? 'reload' : 'attack';
                }
                this.exec(false, act);
            },

            action(type) {
                if(!this.state.active || this.state.p.cd > 0) return;
                if(type==='attack'&&this.state.p.ammo<1) return;
                if(type==='reload'&&this.state.p.ammo>=3) return;
                if(type==='defend'&&this.state.p.ammo<1) return;
                AudioSys.play('click');
                this.exec(true, type);
                if(this.mode==='online') multiplayer.sendState(type);
            },

            exec(isP, type) {
                const actor = isP ? this.state.p : this.state.e;
                const opp = isP ? this.state.e : this.state.p;
                const sprite = isP ? this.dom.p.sprite : this.dom.e.sprite;
                actor.cd = 500;

                if(type === 'reload') {
                    if(actor.ammo < 3) { 
                        actor.ammo++; 
                        sprite.style.transform="scale(1.1)"; 
                        setTimeout(()=>sprite.style.transform="scale(1)", 100); 
                        AudioSys.play('reload'); // NEW SOUND
                    }
                } else if(type === 'defend') {
                    if(actor.ammo > 0) {
                        actor.ammo--; actor.shield = true; AudioSys.play('shield');
                        const s = isP ? this.dom.p.shield : this.dom.e.shield;
                        s.style.opacity = 1; s.style.transform = "scale(1.1)";
                        setTimeout(() => { if(this.state.active) { actor.shield = false; s.style.opacity = 0; s.style.transform = "scale(0.75)"; }}, 800);
                    }
                } else if(type === 'attack') {
                    actor.ammo--; AudioSys.play('shoot'); 
                    sprite.style.transform = `translateY(${isP?-30:30}px)`; setTimeout(()=>sprite.style.transform="translateY(0)", 150);
                    setTimeout(() => this.hit(isP, opp), 200);
                }
                this.updateUI();
            },

            hit(isP, t) {
                if(!this.state.active) return;
                const ts = isP ? this.dom.e.sprite : this.dom.p.sprite;
                if(t.shield) {
                    this.pop(ts, "¬°BLOQUEO!", "#4facfe");
                    const victim = isP ? this.state.p : this.state.e;
                    const vSprite = isP ? this.dom.p.sprite : this.dom.e.sprite; // Reference fix
                    victim.cd = 1500; vSprite.classList.add('stunned'); setTimeout(()=>vSprite.classList.remove('stunned'), 1500);
                } else {
                    t.hp -= 20; AudioSys.play('hit');
                    ts.classList.add('hit-squash'); setTimeout(()=>ts.classList.remove('hit-squash'), 300);
                    this.pop(ts, "-20", "#ff4757");
                    if(t.hp <= 0) this.end(isP);
                }
                this.updateUI();
            },

            end(win) {
                this.state.active = false;
                clearInterval(this.loops); clearInterval(this.aiInt);
                const gain = win ? 30 : -10;
                window.app.trophies = Math.max(0, window.app.trophies + gain);
                window.app.matchesPlayed++;
                window.app.saveLocal();
                
                if(win) AudioSys.playMusic('win');

                setTimeout(() => {
                    if(window.app.matchesPlayed === 3 && !window.app.realUser) {
                        document.getElementById('modal-popup-login').classList.remove('hidden');
                    } else {
                        document.getElementById('modal-title').innerText = win ? "¬°VICTORIA!" : "DERROTA";
                        document.getElementById('modal-title').style.color = win ? "#f1c40f" : "#ff4757";
                        document.getElementById('trophy-change').innerText = (win?"+":"") + gain;
                        this.dom.modalEnd.classList.remove('hidden');
                    }
                }, 600);
            },

            toMenu() { 
                this.dom.modalEnd.classList.add('hidden'); 
                this.dom.game.classList.add('hidden'); 
                document.getElementById('screen-menu').style.display = 'flex'; // Restore
                this.updateMenuUI(); 
            },
            toMenuActual() { this.toMenu(); },
            pop(el, txt, col) { const d = document.createElement('div'); d.className='dmg-pop'; d.innerText=txt; d.style.color=col; const r = el.getBoundingClientRect(); d.style.left=(r.left+20)+'px'; d.style.top=r.top+'px'; document.getElementById('fx-layer').appendChild(d); setTimeout(()=>d.remove(), 800); },
            emote(t) { const e=this.dom.e.emote; e.innerText=t; e.classList.remove('hidden'); setTimeout(()=>e.classList.add('hidden'),1000); },
            updateUI() {
                const p = this.state.p; const e = this.state.e;
                this.dom.p.hp.style.width = Math.max(0,(p.hp/p.max*100))+'%'; this.dom.p.txt.innerText = p.hp;
                this.dom.e.hp.style.width = Math.max(0,(e.hp/e.max*100))+'%'; this.dom.e.txt.innerText = e.hp;
                [0,1,2].forEach(i => {
                    this.dom.p.dots[i].className = i<p.ammo?'dot filled':'dot'; this.dom.p.dots[i].style.background = i<p.ammo?'#2ed573':'#444';
                    this.dom.e.dots[i].className = i<e.ammo?'dot filled':'dot'; this.dom.e.dots[i].style.background = i<e.ammo?'#ff4757':'#444';
                });
            },
            updateBtns() {
                const cd = this.state.p.cd>0; const am = this.state.p.ammo;
                this.dom.btns.atk.disabled = cd || am<1; this.dom.btns.atk.style.opacity = (cd||am<1)?0.3:1;
                this.dom.btns.def.disabled = cd || am<1; this.dom.btns.def.style.opacity = (cd||am<1)?0.3:1;
                this.dom.btns.rel.disabled = cd || am>=3; this.dom.btns.rel.style.opacity = (cd||am>=3)?0.3:1;
            }
        };

        // --- SAFE INIT ---
        setTimeout(() => {
            if(document.getElementById('app-loader').style.display !== 'none') {
                document.getElementById('loader-txt').innerText = "Modo Offline...";
                game.init();
            }
        }, 4000);

        signInAnonymously(auth).then(userCred => {
            window.app.user = userCred.user;
            const savedUser = localStorage.getItem('clashy_user_session');
            if(savedUser) {
                getDoc(window.app.getUserDoc(savedUser)).then(s => {
                    if(s.exists()) {
                        window.app.realUser = s.data();
                        window.app.trophies = s.data().trophies;
                        if(s.data().skin) window.app.currentSkin = s.data().skin;
                    }
                    game.init();
                }).catch(() => game.init());
            } else {
                game.init();
            }
        }).catch(e => {
            console.error("Auth Fail", e);
            game.init();
        });
        
        document.addEventListener('click', () => AudioSys.init(), {once:true});
    </script>
</body>
</html>
