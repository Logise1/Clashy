<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clashy: Battle Arena</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Titan+One&display=swap" rel="stylesheet">
    
    <style>
        :root { --font-toon: 'Titan One', cursive; }
        * { -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-toon);
            background-color: #1a1a1a;
            overflow: hidden; touch-action: none;
            height: 100dvh; width: 100vw;
            display: flex; flex-direction: column;
            user-select: none;
        }

        #app-loader {
            position: fixed; inset: 0; z-index: 9999;
            background: #222; color: white;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column; transition: opacity 0.5s;
        }

        /* --- FONDO --- */
        .toon-bg {
            position: absolute; inset: 0; z-index: -2;
            background: #5dbb63;
            background-image: radial-gradient(#6bcc70 15%, transparent 16%), radial-gradient(#4da852 15%, transparent 16%);
            background-size: 6vmin 6vmin; background-position: 0 0, 3vmin 3vmin;
            pointer-events: none;
        }
        .river {
            position: absolute; top: 45%; left: -10%; width: 120%; height: 8vh;
            background: #4fc3f7; border-top: 0.5vh solid #000; border-bottom: 0.5vh solid #000;
            transform: rotate(-2deg); z-index: -1; pointer-events: none;
        }
        .river::after {
            content: ''; position: absolute; inset: 0;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 20%, transparent 20%);
            background-size: 4vh 4vh; animation: flow 1s linear infinite; opacity: 0.5;
        }
        @keyframes flow { from { transform: translateX(0); } to { transform: translateX(4vh); } }

        /* --- UI --- */
        .toon-panel {
            background: white; border: 0.5vh solid black; border-radius: 3vh;
            box-shadow: 1vh 1vh 0 rgba(0,0,0,0.5); padding: 3vh;
            position: relative; z-index: 10;
        }
        
        .toon-input {
            width: 100%; padding: 1.5vh; margin-bottom: 1.5vh;
            border: 0.4vh solid #333; border-radius: 1.5vh;
            font-family: sans-serif; font-weight: bold; font-size: 2vh;
            outline: none; background: #f0f0f0; color: #000;
            pointer-events: auto; user-select: text; -webkit-user-select: text;
        }
        .toon-input:focus { border-color: #4facfe; background: white; }

        .toon-btn {
            position: relative; border: 0.5vh solid #000; border-radius: 2vh;
            transition: transform 0.1s; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; cursor: pointer;
            user-select: none;
        }
        .toon-btn:active { transform: translateY(0.5vh); box-shadow: none !important; }
        .toon-btn:disabled { filter: grayscale(1); opacity: 0.5; box-shadow: none; transform: translateY(0.5vh); }
        
        .btn-red { background: #ff4757; box-shadow: 0 0.8vh 0 #c0392b; color: white; }
        .btn-blue { background: #2ed573; box-shadow: 0 0.8vh 0 #27ae60; color: white; }
        .btn-gold { background: #f1c40f; box-shadow: 0 0.8vh 0 #d4ac0d; color: #333; }
        .btn-purple { background: #5352ed; box-shadow: 0 0.8vh 0 #3742fa; color: white; }

        /* --- ELEMENTOS JUEGO --- */
        .hp-bar-container {
            height: 3vh; background: #333; border: 0.4vh solid #000; border-radius: 1.5vh;
            overflow: hidden; position: relative;
        }
        .hp-fill { height: 100%; transition: width 0.2s; border-right: 2px solid rgba(0,0,0,0.3); }
        .dot {
            width: 3vh; height: 3vh; border-radius: 50%; background: #444; border: 0.3vh solid #000;
            transition: all 0.2s;
        }
        .dot.filled { transform: scale(1.2); box-shadow: 0 0 0 0.3vh #fff; border-color: #000; }
        
        .toon-char {
            font-size: 12vh; filter: drop-shadow(0.5vh 0.5vh 0 #000);
            transition: transform 0.1s; z-index: 5;
        }
        
        /* Animaciones */
        .zoom-in { animation: zoomIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .zoom-out { animation: zoomOut 0.4s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards; }
        @keyframes zoomIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes zoomOut { from { transform: scale(1); opacity: 1; } to { transform: scale(0.5); opacity: 0; } }
        
        .hit-squash { animation: squash 0.3s; filter: brightness(2) hue-rotate(90deg) !important; }
        .stunned { filter: grayscale(1) blur(2px); animation: shake 0.5s infinite; }
        @keyframes squash { 0% { transform: scale(1, 1); } 30% { transform: scale(1.4, 0.6); } 60% { transform: scale(0.8, 1.2); } 100% { transform: scale(1, 1); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        
        .dmg-pop {
            position: absolute; font-size: 4vh; color: #fff;
            -webkit-text-stroke: 0.3vh black; text-shadow: 0.5vh 0.5vh 0 #000;
            animation: popUp 0.8s forwards; pointer-events: none; z-index: 50; white-space: nowrap;
        }
        @keyframes popUp { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.5) translateY(-5vh); opacity: 1; } 100% { transform: scale(1) translateY(-10vh); opacity: 0; } }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- CARGADOR -->
    <div id="app-loader">
        <h1 class="text-4xl animate-bounce mb-4 text-[#ff4757] -webkit-text-stroke-2 stroke-black">CLASHY</h1>
        <div class="text-sm font-sans font-bold text-gray-400">Cargando sistema...</div>
    </div>

    <div class="toon-bg"></div>
    <div class="river"></div>

    <!-- PANTALLA LOGIN INICIAL -->
    <div id="screen-login" class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="toon-panel w-full max-w-sm text-center transform rotate-1 zoom-in relative">
            
            <!-- Bot√≥n Cerrar (Solo visible si vienes del men√∫) -->
            <button id="btn-close-login" onclick="app.closeLogin()" class="hidden absolute -top-3 -right-3 w-10 h-10 bg-red-500 rounded-full border-2 border-black text-white font-bold">X</button>

            <h1 class="text-5xl text-[#ff4757] -webkit-text-stroke-2 stroke-black drop-shadow-md mb-4">CUENTA</h1>
            
            <div class="flex mb-4 gap-2">
                <button onclick="app.setTab('login')" id="tab-login" class="flex-1 py-2 font-bold border-b-4 border-blue-500 text-blue-500">ENTRAR</button>
                <button onclick="app.setTab('register')" id="tab-register" class="flex-1 py-2 font-bold border-b-4 border-transparent text-gray-400">CREAR</button>
            </div>

            <div id="form-container">
                <input type="text" id="inp-user" placeholder="Nombre de Usuario" class="toon-input">
                <input type="password" id="inp-pass" placeholder="Contrase√±a" class="toon-input">
                
                <button id="btn-action" onclick="app.submitAuth()" class="toon-btn btn-blue w-full h-14 text-xl font-black uppercase mb-2">
                    INICIAR
                </button>
                
                <div id="login-msg" class="text-red-500 font-sans text-sm font-bold min-h-[20px]"></div>
            </div>
            
            <button id="btn-guest" onclick="app.playAsGuest()" class="mt-4 text-gray-500 font-bold underline text-sm cursor-pointer">Jugar como Invitado</button>
        </div>
    </div>

    <!-- PANTALLA MENU -->
    <div id="screen-menu" class="absolute inset-0 z-40 flex flex-col items-center justify-center p-4">
        <div id="menu-container" class="toon-panel w-full max-w-sm text-center transform -rotate-1 zoom-in">
            
            <!-- Header Usuario -->
            <div class="flex justify-between items-center mb-4 border-b-2 border-gray-200 pb-2">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-blue-500 border-2 border-black flex items-center justify-center text-white text-xs">üë§</div>
                    <div class="flex flex-col items-start leading-none">
                        <span id="menu-user" class="font-bold text-sm text-gray-700">Invitado</span>
                        <span id="user-status" class="text-[10px] text-red-500 font-bold cursor-pointer underline" onclick="app.goToLoginScreen()">¬°CONECTAR!</span>
                    </div>
                </div>
                <button onclick="app.logout()" class="text-xs bg-gray-200 text-gray-600 px-3 py-1 rounded-full font-bold border border-gray-400">Salir</button>
            </div>

            <h1 class="text-6xl text-[#ff4757] -webkit-text-stroke-2 stroke-black mb-2 drop-shadow-md">CLASHY</h1>
            
            <div class="bg-yellow-100 border-4 border-black rounded-2xl p-4 mb-6 relative">
                <div class="text-xs font-bold uppercase mb-1 text-yellow-800">TUS COPAS</div>
                <div class="text-5xl drop-shadow-sm">üèÜ <span id="menu-trophies">0</span></div>
            </div>

            <button onclick="game.start()" class="w-full toon-btn btn-red h-20 text-3xl font-black uppercase mb-4 shadow-xl">
                ¬°LUCHAR!
            </button>
            
            <button onclick="app.showLeaderboard()" class="w-full toon-btn btn-gold h-14 text-xl font-black uppercase shadow-lg">
                üèÜ RANKING
            </button>
        </div>
    </div>

    <!-- PANTALLA JUEGO -->
    <div id="screen-game" class="hidden absolute inset-0 z-10 flex flex-col h-full w-full">
        <div id="game-container" class="w-full h-full flex flex-col">
            <!-- RIVAL -->
            <div class="h-[40%] flex flex-col items-center justify-center relative">
                <div class="w-[80%] max-w-md absolute top-4 z-20">
                    <div class="flex justify-between text-white font-black text-[2vh] mb-1 drop-shadow-md px-1">
                        <span class="text-red-500 stroke-black" style="-webkit-text-stroke: 1px black;">RIVAL</span>
                        <span id="e-hp-txt">100%</span>
                    </div>
                    <div class="hp-bar-container"><div id="e-hp-bar" class="hp-fill bg-[#ff4757]"></div></div>
                    <div class="flex justify-center gap-2 mt-1">
                        <div id="e-dot-1" class="dot bg-red-600"></div><div id="e-dot-2" class="dot bg-red-600"></div><div id="e-dot-3" class="dot bg-red-600"></div>
                    </div>
                </div>
                <div class="relative mt-8">
                    <div id="e-sprite" class="toon-char scale-x-[-1]">üëπ</div>
                    <div id="e-emote" class="absolute -top-[5vh] -right-[5vh] bg-white border-4 border-black p-2 rounded-full hidden animate-bounce z-30 text-[4vh]">üõ°Ô∏è</div>
                    <div id="e-shield" class="absolute -inset-[2vh] border-[1vh] border-blue-400 rounded-full opacity-0 scale-75 transition-all"></div>
                </div>
            </div>

            <!-- PLAYER -->
            <div class="h-[60%] flex flex-col items-center justify-end pb-[safe-area-inset-bottom] relative">
                <div id="status-msg" class="absolute top-10 text-white font-black text-[3vh] drop-shadow-md opacity-0 bg-black/50 px-4 rounded-full pointer-events-none"></div>
                
                <div class="relative mb-2">
                    <div id="p-sprite" class="toon-char">ü§†</div>
                    <div id="p-shield" class="absolute -inset-[2vh] border-[1vh] border-blue-400 rounded-full opacity-0 scale-75 transition-all"></div>
                </div>

                <div class="w-[80%] max-w-md mb-4">
                    <div class="flex justify-between text-white font-black text-[2vh] mb-1 drop-shadow-md px-1">
                        <span class="text-blue-400 stroke-black" style="-webkit-text-stroke: 1px black;">T√ö</span>
                        <span id="p-hp-txt">100%</span>
                    </div>
                    <div class="hp-bar-container"><div id="p-hp-bar" class="hp-fill bg-[#2ed573]"></div></div>
                    <div class="flex justify-center gap-2 mt-1">
                        <div id="p-dot-1" class="dot bg-[#2ed573]"></div><div id="p-dot-2" class="dot bg-[#2ed573]"></div><div id="p-dot-3" class="dot bg-[#2ed573]"></div>
                    </div>
                </div>

                <div class="w-full px-4 pb-6 grid grid-cols-3 gap-3 h-[18vh] max-h-[160px] max-w-lg relative">
                    <div id="tutorial-hand" class="absolute hidden text-6xl drop-shadow-md z-50 animate-bounce pointer-events-none">üëá</div>
                    
                    <button id="btn-reload" onclick="game.action('reload')" class="toon-btn btn-blue group">
                        <i class="fas fa-bolt group-active:scale-90 transition-transform text-[4vh]"></i>
                        <span class="font-black uppercase text-[1.5vh]">Cargar</span>
                    </button>
                    <button id="btn-defend" onclick="game.action('defend')" class="toon-btn btn-purple group">
                        <i class="fas fa-shield-alt group-active:scale-90 transition-transform text-[4vh]"></i>
                        <span class="font-black uppercase text-[1.5vh] text-xs">Escudo(1)</span>
                    </button>
                    <button id="btn-attack" onclick="game.action('attack')" class="toon-btn btn-red group z-20 transform -translate-y-[1vh]">
                        <i class="fas fa-bomb text-[5vh] group-active:scale-90 transition-transform"></i>
                        <span class="text-[2vh] font-black mt-1 uppercase">¬°FUEGO!</span>
                    </button>
                </div>
            </div>
            <div id="fx-layer" class="absolute inset-0 pointer-events-none overflow-hidden"></div>
        </div>
    </div>

    <!-- MODAL FINAL -->
    <div id="modal-end" class="hidden absolute inset-0 z-50 flex items-center justify-center bg-black/80 p-4">
        <div class="toon-panel w-full max-w-sm text-center transform rotate-1 zoom-in">
            <h2 id="modal-title" class="text-5xl font-black mb-4 -webkit-text-stroke-2 stroke-black text-[#f1c40f]">¬°VICTORIA!</h2>
            <div class="flex justify-center items-center gap-4 mb-8">
                <span class="text-6xl">üèÜ</span>
                <span id="trophy-change" class="text-5xl font-black text-[#333]">+20</span>
            </div>
            <button onclick="game.toMenu()" class="toon-btn btn-blue w-full h-16 text-2xl font-black uppercase">CONTINUAR</button>
        </div>
    </div>

    <!-- POPUP LOGIN -->
    <div id="modal-popup-login" class="hidden absolute inset-0 z-60 flex items-center justify-center bg-black/90 p-4">
        <div class="toon-panel w-full max-w-sm text-center zoom-in relative">
            <button onclick="app.skipPopup()" class="absolute top-2 right-4 text-gray-400 font-bold text-2xl">√ó</button>
            <h2 class="text-3xl text-[#5352ed] font-black mb-2 stroke-black">¬°GUARDA TU PROGRESO!</h2>
            <p class="text-sm text-gray-600 mb-6 font-bold">Llevas 3 partidas. Crea una cuenta para no perder tus copas.</p>
            <button onclick="app.goToLoginScreen(true)" class="toon-btn btn-gold w-full h-14 text-xl font-black uppercase mb-2">CREAR CUENTA</button>
            <button onclick="app.skipPopup()" class="text-xs text-gray-400 font-bold underline mt-2">Seguir como invitado</button>
        </div>
    </div>

    <!-- PANTALLA RANKING -->
    <div id="screen-ranking" class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center p-4 bg-black/80">
        <div class="toon-panel w-full max-w-sm text-center relative zoom-in">
            <button onclick="document.getElementById('screen-ranking').classList.add('hidden')" class="absolute -top-4 -right-4 bg-red-500 text-white w-10 h-10 rounded-full border-2 border-black font-bold">X</button>
            <h2 class="text-3xl text-[#f1c40f] -webkit-text-stroke-1 stroke-black mb-4 drop-shadow-md font-black">TOP MUNDIAL</h2>
            <div id="ranking-list" class="bg-gray-100 rounded-xl h-64 overflow-y-auto text-left font-sans text-sm border-2 border-gray-300 p-2">
                <div class="text-center text-gray-400 mt-10">Cargando...</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBi5fQUumRe3zDb82mOcbl_m3JxP_9vVO4",
            authDomain: "toon-acb19.firebaseapp.com",
            projectId: "toon-acb19",
            storageBucket: "toon-acb19.firebasestorage.app",
            messagingSenderId: "627627273918",
            appId: "1:627627273918:web:55132292fc07d4a06e38ef",
            measurementId: "G-6MMXY2SG4D"
        };

        const fApp = initializeApp(firebaseConfig);
        const auth = getAuth(fApp);
        const db = getFirestore(fApp);

        // --- AUDIO ---
        const AudioSys = {
            ctx: null,
            init() { if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); },
            play(type) {
                if(!this.ctx) return;
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain); gain.connect(this.ctx.destination);

                if(type === 'hit') {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, t); gain.gain.setValueAtTime(0.5, t); gain.gain.exponentialRampToValueAtTime(0.01, t+0.2); osc.start(t); osc.stop(t+0.2);
                } else if(type === 'shoot') {
                    osc.type = 'square'; osc.frequency.setValueAtTime(300, t); osc.frequency.linearRampToValueAtTime(50, t+0.1); gain.gain.setValueAtTime(0.3, t); gain.gain.exponentialRampToValueAtTime(0.01, t+0.1); osc.start(t); osc.stop(t+0.1);
                } else if(type === 'shield') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(200, t); osc.frequency.linearRampToValueAtTime(600, t+0.3); gain.gain.setValueAtTime(0.3, t); osc.start(t); osc.stop(t+0.3);
                }
            }
        };

        // --- LOGICA APP ---
        window.app = {
            user: null,
            trophies: parseInt(localStorage.getItem('clashy_trophies') || 0),
            matchesPlayed: parseInt(localStorage.getItem('clashy_matches') || 0),
            authMode: 'login',

            setTab(mode) {
                this.authMode = mode;
                const btnL = document.getElementById('tab-login');
                const btnR = document.getElementById('tab-register');
                const btnAct = document.getElementById('btn-action');
                if(mode === 'login') {
                    btnL.className = "flex-1 py-2 font-bold border-b-4 border-blue-500 text-blue-500";
                    btnR.className = "flex-1 py-2 font-bold border-b-4 border-transparent text-gray-400";
                    btnAct.innerText = "INICIAR";
                    btnAct.classList.replace('btn-purple', 'btn-blue');
                } else {
                    btnR.className = "flex-1 py-2 font-bold border-b-4 border-purple-500 text-purple-500";
                    btnL.className = "flex-1 py-2 font-bold border-b-4 border-transparent text-gray-400";
                    btnAct.innerText = "CREAR";
                    btnAct.classList.replace('btn-blue', 'btn-purple');
                }
            },

            playAsGuest() {
                document.getElementById('screen-login').classList.add('hidden');
                document.getElementById('screen-menu').classList.remove('hidden');
                game.init(); 
            },

            goToLoginScreen(fromMenu = false) {
                document.getElementById('modal-popup-login').classList.add('hidden');
                document.getElementById('screen-menu').classList.add('hidden');
                document.getElementById('screen-login').classList.remove('hidden');
                
                // Mostrar bot√≥n cerrar si venimos del men√∫
                if(fromMenu) {
                    document.getElementById('btn-close-login').classList.remove('hidden');
                    document.getElementById('btn-guest').classList.add('hidden'); // Ocultar jugar como invitado si ya estamos dentro
                } else {
                    document.getElementById('btn-close-login').classList.add('hidden');
                    document.getElementById('btn-guest').classList.remove('hidden');
                }
            },

            closeLogin() {
                document.getElementById('screen-login').classList.add('hidden');
                document.getElementById('screen-menu').classList.remove('hidden');
            },

            skipPopup() {
                document.getElementById('modal-popup-login').classList.add('hidden');
                game.toMenuActual();
            },

            submitAuth: async () => {
                const u = document.getElementById('inp-user').value;
                const p = document.getElementById('inp-pass').value;
                const m = document.getElementById('login-msg');
                const email = u.replace(/\s/g, '') + "@clashy.com";

                if(!u || !p) { m.innerText = "Faltan datos"; return; }
                m.innerText = "Procesando...";

                try {
                    if(window.app.authMode === 'login') {
                        await signInWithEmailAndPassword(auth, email, p);
                    } else {
                        const c = await createUserWithEmailAndPassword(auth, email, p);
                        await setDoc(doc(db, "users", c.user.uid), { username: u, trophies: window.app.trophies });
                    }
                } catch(e) { 
                    if(e.code === 'auth/email-already-in-use') m.innerText = "Usuario ya existe";
                    else if(e.code === 'auth/wrong-password') m.innerText = "Contrase√±a mal";
                    else if(e.code === 'auth/user-not-found') m.innerText = "Usuario no existe";
                    else m.innerText = "Error: " + e.code; 
                }
            },

            logout: () => signOut(auth).then(() => window.location.reload()),

            saveLocal: () => {
                localStorage.setItem('clashy_trophies', window.app.trophies);
                localStorage.setItem('clashy_matches', window.app.matchesPlayed);
                if(window.app.user) setDoc(doc(db, "users", window.app.user.uid), { trophies: window.app.trophies }, { merge: true });
            },

            showLeaderboard: async () => {
                document.getElementById('screen-ranking').classList.remove('hidden');
                const list = document.getElementById('ranking-list');
                list.innerHTML = '<div class="text-center p-4">Cargando...</div>';
                try {
                    const q = query(collection(db, "users"), orderBy("trophies", "desc"), limit(10));
                    const querySnapshot = await getDocs(q);
                    list.innerHTML = "";
                    let rank = 1;
                    querySnapshot.forEach((doc) => {
                        const d = doc.data();
                        const color = rank === 1 ? 'text-yellow-500' : (rank === 2 ? 'text-gray-400' : 'text-gray-600');
                        list.innerHTML += `
                            <div class="flex justify-between p-2 border-b border-gray-300 items-center">
                                <span class="font-black ${color} w-8">#${rank++}</span>
                                <span class="font-bold flex-1 text-gray-700">${d.username}</span>
                                <span class="font-bold text-black">${d.trophies} üèÜ</span>
                            </div>`;
                    });
                } catch(e) { list.innerText = "Ranking no disponible"; }
            }
        };

        // --- MOTOR JUEGO ---
        window.game = {
            dom: null, state: null,
            
            init() {
                this.dom = {
                    menu: document.getElementById('screen-menu'),
                    menuCont: document.getElementById('menu-container'),
                    game: document.getElementById('screen-game'),
                    gameCont: document.getElementById('game-container'),
                    modalEnd: document.getElementById('modal-end'),
                    p: { hp: document.getElementById('p-hp-bar'), txt: document.getElementById('p-hp-txt'), sprite: document.getElementById('p-sprite'), dots: [1,2,3].map(i=>document.getElementById(`p-dot-${i}`)), shield: document.getElementById('p-shield') },
                    e: { hp: document.getElementById('e-hp-bar'), txt: document.getElementById('e-hp-txt'), sprite: document.getElementById('e-sprite'), dots: [1,2,3].map(i=>document.getElementById(`e-dot-${i}`)), shield: document.getElementById('e-shield'), emote: document.getElementById('e-emote') },
                    btns: { atk: document.getElementById('btn-attack'), def: document.getElementById('btn-defend'), rel: document.getElementById('btn-reload') },
                    tut: document.getElementById('tutorial-hand')
                };
                this.updateMenuUI();
                // Ocultar Loader
                const l = document.getElementById('app-loader');
                l.style.opacity = '0';
                setTimeout(() => l.style.display = 'none', 500);
            },

            updateMenuUI() {
                document.getElementById('menu-trophies').innerText = window.app.trophies;
                const uLabel = document.getElementById('menu-user');
                const uStatus = document.getElementById('user-status');
                
                if(window.app.user) {
                    uLabel.innerText = "Cargando...";
                    uStatus.innerText = "CONECTADO";
                    uStatus.className = "text-[10px] text-green-500 font-bold";
                    getDoc(doc(db, "users", window.app.user.uid)).then(s => { if(s.exists()) uLabel.innerText = s.data().username; });
                } else {
                    uLabel.innerText = "Invitado";
                    uStatus.innerText = "¬°CONECTAR!";
                    uStatus.className = "text-[10px] text-red-500 font-bold cursor-pointer underline animate-pulse";
                }
                this.dom.menuCont.classList.remove('zoom-out');
                this.dom.menuCont.classList.add('zoom-in');
            },

            start() {
                this.dom.menuCont.classList.remove('zoom-in');
                this.dom.menuCont.classList.add('zoom-out');

                setTimeout(() => {
                    this.dom.menu.classList.add('hidden');
                    this.dom.game.classList.remove('hidden');
                    this.dom.gameCont.classList.remove('zoom-out');
                    this.dom.gameCont.classList.add('zoom-in');

                    const t = window.app.trophies;
                    this.isTut = t === 0;
                    
                    let eHP = 200, eDmg = 15;
                    if(t > 100) { eHP = 300; eDmg = 25; }
                    
                    this.state = {
                        active: true,
                        p: { hp: 300, max: 300, ammo: 0, shield: false, cd: 0, dmg: 25 },
                        e: { hp: eHP, max: eHP, ammo: 0, shield: false, cd: 0, dmg: eDmg }
                    };

                    if(this.isTut) this.tutStep(1);
                    this.updateUI();
                    this.loops = setInterval(() => this.loop(), 50);
                    if(!this.isTut) this.aiInt = setInterval(() => this.ai(), 1000);
                }, 400);
            },

            loop() {
                if(this.state.p.cd > 0) this.state.p.cd -= 50;
                if(this.state.e.cd > 0) this.state.e.cd -= 50;
                this.updateBtns();
            },

            ai() {
                if(!this.state.active || this.state.e.cd > 0) return;
                const p = this.state.p; const e = this.state.e;
                let act = 'reload';

                // IA SEGURA: Jam√°s escudo con 0 balas
                if (e.ammo === 0) {
                    act = 'reload';
                } else {
                    if (p.ammo === 0 && e.ammo > 0) act = 'attack'; 
                    else if (p.ammo > 0 && Math.random() < 0.4) {
                        act = 'defend'; this.emote('üõ°Ô∏è');
                    } else {
                        act = e.ammo < 3 ? 'reload' : 'attack';
                    }
                }
                this.exec(false, act);
            },

            action(type) {
                if(!this.state.active || this.state.p.cd > 0) return;
                if(this.isTut && ((this.tutP===1 && type!=='reload') || (this.tutP===2 && type!=='attack'))) return;

                if(type==='attack' && this.state.p.ammo<1) return;
                if(type==='reload' && this.state.p.ammo>=3) return;
                if(type==='defend' && this.state.p.ammo<1) return;

                this.exec(true, type);

                if(this.isTut) {
                    if(this.tutP===1) this.tutStep(2);
                    else if(this.tutP===2) this.tutStep(3);
                }
            },

            exec(isP, type) {
                const actor = isP ? this.state.p : this.state.e;
                const opp = isP ? this.state.e : this.state.p;
                const sprite = isP ? this.dom.p.sprite : this.dom.e.sprite;
                actor.cd = 500;

                if(type === 'reload') {
                    if(actor.ammo < 3) { actor.ammo++; sprite.style.transform="scale(1.1)"; setTimeout(()=>sprite.style.transform="scale(1)", 100); }
                } else if(type === 'defend') {
                    if(actor.ammo > 0) {
                        actor.ammo--; actor.shield = true; AudioSys.play('shield');
                        const s = isP ? this.dom.p.shield : this.dom.e.shield;
                        s.style.opacity = 1; s.style.transform = "scale(1.1)";
                        setTimeout(() => { if(this.state.active) { actor.shield = false; s.style.opacity = 0; s.style.transform = "scale(0.75)"; }}, 800);
                    }
                } else if(type === 'attack') {
                    actor.ammo--; AudioSys.play('shoot'); 
                    sprite.style.transform = `translateY(${isP?-30:30}px)`; setTimeout(()=>sprite.style.transform="translateY(0)", 150);
                    setTimeout(() => this.hit(isP, opp), 200);
                }
                this.updateUI();
            },

            hit(isP, t) {
                if(!this.state.active) return;
                const ts = isP ? this.dom.e.sprite : this.dom.p.sprite;
                if(t.shield) {
                    this.pop(ts, "¬°BLOQUEO!", "#4facfe");
                    if(isP) { // Stun
                        this.state.p.cd = 2000; this.dom.p.sprite.classList.add('stunned');
                        setTimeout(()=>this.dom.p.sprite.classList.remove('stunned'), 2000);
                    }
                } else {
                    const dmg = isP ? this.state.p.dmg : this.state.e.dmg;
                    t.hp -= dmg; AudioSys.play('hit');
                    ts.classList.add('hit-squash'); setTimeout(()=>ts.classList.remove('hit-squash'), 300);
                    this.pop(ts, `-${dmg}`, "#ff4757");
                    if(t.hp <= 0) this.end(isP);
                }
                this.updateUI();
            },

            end(win) {
                this.state.active = false;
                clearInterval(this.loops); clearInterval(this.aiInt);
                this.dom.gameCont.classList.remove('zoom-in');
                this.dom.gameCont.classList.add('zoom-out');

                const gain = win ? 20 : -10;
                window.app.trophies = Math.max(0, window.app.trophies + gain);
                window.app.matchesPlayed++;
                window.app.saveLocal();

                setTimeout(() => {
                    if(window.app.matchesPlayed === 3 && !window.app.user) {
                        document.getElementById('modal-popup-login').classList.remove('hidden');
                    } else {
                        document.getElementById('modal-title').innerText = win ? "¬°VICTORIA!" : "DERROTA";
                        document.getElementById('modal-title').style.color = win ? "#f1c40f" : "#ff4757";
                        document.getElementById('trophy-change').innerText = (win?"+":"") + gain;
                        this.dom.modalEnd.classList.remove('hidden');
                    }
                }, 600);
            },

            toMenu() {
                this.dom.modalEnd.classList.add('hidden');
                this.dom.game.classList.add('hidden');
                this.dom.menu.classList.remove('hidden');
                this.updateMenuUI();
            },
            
            toMenuActual() {
                this.dom.game.classList.add('hidden');
                this.dom.menu.classList.remove('hidden');
                this.updateMenuUI();
            },

            tutStep(n) {
                this.tutP = n; const h = this.dom.tut; h.classList.remove('hidden');
                const r = [this.dom.btns.rel, this.dom.btns.atk, this.dom.btns.def][n-1].getBoundingClientRect();
                h.style.top=(r.top-60)+'px'; h.style.left=(r.left+r.width/2-20)+'px';
                if(n===3) setTimeout(()=>{ h.classList.add('hidden'); this.isTut=false; this.aiInt=setInterval(()=>this.ai(),2000); }, 3000);
            },
            pop(el, txt, col) {
                const d = document.createElement('div'); d.className='dmg-pop'; d.innerText=txt; d.style.color=col;
                const r = el.getBoundingClientRect(); d.style.left=(r.left+20)+'px'; d.style.top=r.top+'px';
                document.getElementById('fx-layer').appendChild(d); setTimeout(()=>d.remove(), 800);
            },
            emote(t) { const e=this.dom.e.emote; e.innerText=t; e.classList.remove('hidden'); setTimeout(()=>e.classList.add('hidden'),1000); },
            updateUI() {
                const p = this.state.p; const e = this.state.e;
                this.dom.p.hp.style.width = Math.max(0,(p.hp/p.max*100))+'%'; this.dom.p.txt.innerText = Math.ceil(Math.max(0,p.hp/p.max*100))+'%';
                this.dom.e.hp.style.width = Math.max(0,(e.hp/e.max*100))+'%'; this.dom.e.txt.innerText = Math.ceil(Math.max(0,e.hp/e.max*100))+'%';
                [0,1,2].forEach(i => {
                    this.dom.p.dots[i].className = i<p.ammo?'dot filled':'dot'; this.dom.p.dots[i].style.background = i<p.ammo?'#2ed573':'#444';
                    this.dom.e.dots[i].className = i<e.ammo?'dot filled':'dot'; this.dom.e.dots[i].style.background = i<e.ammo?'#ff4757':'#444';
                });
            },
            updateBtns() {
                const cd = this.state.p.cd>0; const am = this.state.p.ammo;
                this.dom.btns.atk.disabled = cd || am<1; this.dom.btns.atk.style.opacity = (cd||am<1)?0.3:1;
                this.dom.btns.def.disabled = cd || am<1; this.dom.btns.def.style.opacity = (cd||am<1)?0.3:1;
                this.dom.btns.rel.disabled = cd || am>=3; this.dom.btns.rel.style.opacity = (cd||am>=3)?0.3:1;
            }
        };

        // --- AUTH ---
        onAuthStateChanged(auth, (u) => {
            if(u) {
                window.app.user = u;
                document.getElementById('screen-login').classList.add('hidden');
                document.getElementById('screen-menu').classList.remove('hidden');
                getDoc(doc(db, "users", u.uid)).then(s => {
                    if(s.exists()) window.app.trophies = Math.max(window.app.trophies, s.data().trophies);
                    game.init();
                });
            } else {
                if(document.getElementById('screen-menu').classList.contains('hidden')) {
                    document.getElementById('screen-login').classList.remove('hidden');
                }
                game.init();
            }
        });
        
        document.addEventListener('click', () => AudioSys.init(), {once:true});
    </script>
</body>
</html>
